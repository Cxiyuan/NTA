services:
  cap-agent:
    image: cap-agent:latest
    container_name: cap-agent
    hostname: cap-agent
    privileged: true
    network_mode: host
    restart: unless-stopped
    
    environment:
      - ZEEK_IFACE=eth0
      - ZEEK_LOG_DIR=/var/spool/zeek
      - PYTHONUNBUFFERED=1
    
    volumes:
      - ./logs:/opt/cap-agent/logs
      - ./reports:/opt/cap-agent/reports
      - ./config:/opt/cap-agent/config
      - /var/spool/zeek:/var/spool/zeek
    
    command: all
    
    healthcheck:
      test: ["CMD", "zeekctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  cap-agent-backend:
    image: cap-agent:latest
    container_name: cap-agent-backend
    hostname: cap-agent-backend
    restart: unless-stopped
    
    environment:
      - PYTHONUNBUFFERED=1
    
    ports:
      - "5000:5000"
    
    volumes:
      - ./logs:/opt/cap-agent/logs
      - ./reports:/opt/cap-agent/reports
      - ./config:/opt/cap-agent/config
    
    command: backend
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  cap-agent-analyzer:
    image: cap-agent:latest
    container_name: cap-agent-analyzer
    hostname: cap-agent-analyzer
    restart: unless-stopped
    
    environment:
      - PYTHONUNBUFFERED=1
    
    volumes:
      - ./logs:/opt/cap-agent/logs
      - ./reports:/opt/cap-agent/reports
      - ./config:/opt/cap-agent/config
      - /var/spool/zeek:/var/spool/zeek
    
    command: analyzer
    
    depends_on:
      - cap-agent

volumes:
  zeek-logs:
    driver: local
  cap-agent-logs:
    driver: local
  cap-agent-reports:
    driver: local
