# NTA 系统架构文档

## 系统概览

NTA (Network Traffic Analysis) 是一个基于 Go 语言开发的企业级网络流量分析和威胁检测平台,集成了流量采集、威胁情报、异常检测等多项安全能力。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Web UI   │  │  CLI     │  │ REST API │  │ Grafana  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                      API网关层                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • JWT认证  • RBAC授权  • 限流  • 日志  • 指标     │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                      服务层                                  │
│  ┌───────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  告警服务 │  │ 资产服务  │  │ 威胁情报 │  │ 探针管理 │  │
│  └───────────┘  └──────────┘  └──────────┘  └──────────┘  │
│  ┌───────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  审计服务 │  │ 授权服务  │  │ 备份服务 │  │ 报表服务 │  │
│  └───────────┘  └──────────┘  └──────────┘  └──────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    检测引擎层                                │
│  ┌───────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 横向移动  │  │ APT检测  │  │ 加密分析 │  │ ML异常   │  │
│  │ 检测      │  │          │  │          │  │ 检测     │  │
│  └───────────┘  └──────────┘  └──────────┘  └──────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    数据采集层                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Zeek 流量解析引擎                       │   │
│  │  • conn.log  • dns.log  • http.log  • ssl.log       │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    存储层                                    │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐         │
│  │ SQLite/  │      │  Redis   │      │  文件    │         │
│  │ MySQL/   │      │  (缓存)  │      │  存储    │         │
│  │ Postgres │      │          │      │          │         │
│  └──────────┘      └──────────┘      └──────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. API服务 (internal/api)
- **职责**: 提供RESTful API接口
- **技术栈**: Gin框架
- **功能**:
  - JWT认证和RBAC授权
  - 限流保护
  - 请求日志和指标采集
  - 健康检查

### 2. 检测引擎 (internal/analyzer)
- **横向移动检测**: 识别端口扫描、PTH攻击、PSExec/WMI远程执行
- **异常检测**: 基于机器学习的流量异常识别
- **APT检测**: Kill Chain分析和IOC狩猎

### 3. 威胁情报服务 (internal/threatintel)
- **外部情报源**: 集成ThreatFox等公开威胁情报
- **本地缓存**: 减少外部API调用
- **自动更新**: 定时同步最新威胁数据

### 4. 资产发现 (internal/asset)
- **被动发现**: 基于流量自动识别网络资产
- **指纹识别**: OS、服务、厂商识别
- **资产追踪**: 首次/最后活跃时间

### 5. 探针管理 (internal/probe)
- **多探针协同**: 支持分布式部署
- **心跳监控**: 实时监控探针状态
- **能力协商**: 探针功能动态配置

### 6. 审计服务 (internal/audit)
- **完整审计**: 记录所有操作
- **完整性校验**: SHA256校验和
- **合规支持**: 满足安全合规要求

### 7. License管理 (internal/license)
- **RSA签名**: 防篡改
- **功能控制**: 基于授权启用功能
- **到期检测**: 自动验证有效期

## 数据流

```
网络流量 
  ↓
Zeek解析 (conn.log, dns.log, http.log, ssl.log)
  ↓
检测引擎处理
  ├─→ 横向移动检测 → 告警
  ├─→ 威胁情报匹配 → 告警
  ├─→ 异常检测 → 告警
  └─→ 资产发现 → 资产库更新
  ↓
存储到数据库
  ↓
API查询展示
```

## 技术选型

| 组件 | 技术 | 说明 |
|------|------|------|
| 编程语言 | Go 1.21 | 高性能、并发友好 |
| Web框架 | Gin | 轻量级、高性能 |
| 数据库 | SQLite/MySQL/Postgres | 灵活配置 |
| 缓存 | Redis | 威胁情报缓存 |
| 流量采集 | Zeek 6.0.3 | 网络流量分析 |
| 认证 | JWT | 无状态认证 |
| 监控 | Prometheus | 指标采集 |
| 容器化 | Docker | 标准化部署 |
| 编排 | Kubernetes | 生产环境部署 |

## 安全设计

### 认证与授权
- **JWT Token**: 基于HS256签名
- **RBAC**: 角色包括admin、analyst、viewer
- **最小权限**: 默认拒绝,显式授权

### 数据安全
- **传输加密**: 支持TLS/HTTPS
- **存储加密**: 敏感数据加密存储
- **审计日志**: 完整性校验,防篡改

### 防护措施
- **限流**: 100请求/分钟
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 输入验证和输出编码
- **CSRF防护**: Token验证

## 性能优化

### 缓存策略
- **威胁情报缓存**: Redis + 内存双层缓存,TTL 1小时
- **查询结果缓存**: 分页查询结果缓存

### 数据库优化
- **索引**: 关键字段创建索引(severity, status, timestamp等)
- **分页**: 限制单次查询数量,最大100条
- **连接池**: 复用数据库连接

### 并发处理
- **Goroutine**: 后台任务异步处理
- **Channel**: 任务队列解耦
- **互斥锁**: 共享资源保护

## 监控与告警

### 指标监控
- **业务指标**: 告警数量、探针状态、资产数量
- **性能指标**: 请求延迟、数据库查询时间
- **系统指标**: CPU、内存、磁盘使用率

### 健康检查
- **Liveness**: 进程存活检查
- **Readiness**: 服务就绪检查(数据库、Redis连通性)

### 日志管理
- **结构化日志**: JSON格式,便于解析
- **日志级别**: Debug、Info、Warn、Error
- **日志轮转**: 按大小和时间轮转

## 部署架构

### 单机部署
```
┌──────────────────┐
│   NTA Server     │
│  ┌────────────┐  │
│  │ API+Engine │  │
│  └────────────┘  │
│  ┌────────────┐  │
│  │   Redis    │  │
│  └────────────┘  │
│  ┌────────────┐  │
│  │  SQLite    │  │
│  └────────────┘  │
└──────────────────┘
```

### 分布式部署
```
        ┌──────────────┐
        │ Load Balancer│
        └──────┬───────┘
               │
     ┌─────────┼─────────┐
     │         │         │
┌────▼───┐ ┌──▼────┐ ┌──▼────┐
│NTA     │ │NTA    │ │NTA    │
│Server 1│ │Server2│ │Server3│
└────┬───┘ └───┬───┘ └───┬───┘
     │         │         │
     └─────────┼─────────┘
               │
     ┌─────────┼─────────┐
     │         │         │
┌────▼───┐ ┌──▼─────┐ ┌─▼──────┐
│ Redis  │ │ MySQL  │ │ Backup │
│Cluster │ │Master/ │ │ Service│
│        │ │Replica │ │        │
└────────┘ └────────┘ └────────┘
```

### Kubernetes部署
- **Deployment**: 3副本,滚动更新
- **HPA**: CPU 70%, Memory 80%自动扩缩容
- **PVC**: 数据持久化
- **Service**: LoadBalancer对外暴露

## 扩展性

### 水平扩展
- **无状态设计**: API服务可水平扩展
- **共享存储**: Redis和数据库集群化

### 垂直扩展
- **资源配置**: 根据负载调整CPU/内存
- **数据库**: 从SQLite迁移到MySQL/Postgres

### 功能扩展
- **插件化**: 检测引擎模块化设计
- **配置驱动**: 威胁情报源可配置
- **多租户**: 预留tenant_id字段

## 灾难恢复

### 备份策略
- **自动备份**: 每24小时自动备份
- **保留策略**: 保留7天备份
- **压缩存储**: Gzip压缩节省空间

### 恢复流程
1. 停止服务
2. 从备份文件恢复数据库
3. 验证数据完整性
4. 重启服务

## 开发规范

### 代码结构
```
NTA/
├── cmd/                # 应用入口
├── internal/           # 内部包
│   ├── api/           # API服务
│   ├── analyzer/      # 检测引擎
│   ├── config/        # 配置管理
│   └── ...
├── pkg/               # 可复用包
│   ├── middleware/    # 中间件
│   ├── metrics/       # 指标
│   └── ...
├── config/            # 配置文件
├── deploy/            # 部署文件
├── docs/              # 文档
└── tests/             # 测试
```

### 测试规范
- **单元测试**: 核心逻辑100%覆盖
- **集成测试**: API端到端测试
- **性能测试**: 压力测试和基准测试

## 未来规划

1. **AI增强检测**: 深度学习模型集成
2. **实时流处理**: Apache Kafka集成
3. **可视化增强**: 攻击链路图、拓扑图
4. **多租户完整支持**: 租户隔离和配额管理
5. **全文搜索**: Elasticsearch集成
