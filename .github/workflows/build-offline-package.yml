name: Build Offline Deployment Package

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_VERSION: "24.0.7"
  DOCKER_COMPOSE_VERSION: "2.24.0"
  CONTAINERD_VERSION: "1.7.11"

jobs:
  build-offline-package:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment variables
        run: |
          echo "BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "VERSION=$(git describe --tags --always || echo 'dev')" >> $GITHUB_ENV
          echo "GIT_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Build backend image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --build-arg VERSION=${{ env.VERSION }} \
            --build-arg BUILD_TIME=${{ env.BUILD_TIME }} \
            --build-arg GIT_COMMIT=${{ env.GIT_COMMIT }} \
            -t nta-server:v1.0.0 \
            --output type=docker,dest=/tmp/nta-server.tar \
            .

      - name: Build Kafka consumer image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t nta-kafka-consumer:v1.0.0 \
            -f cmd/kafka-consumer/Dockerfile \
            --output type=docker,dest=/tmp/nta-kafka-consumer.tar \
            .

      - name: Build frontend image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t nta-web:v2.0.0 \
            --output type=docker,dest=/tmp/nta-web.tar \
            ./web

      - name: Build microservices images
        run: |
          # Auth Service
          docker buildx build \
            --platform linux/amd64 \
            -t nta-auth-service:v2.0.0 \
            -f services/auth-service/Dockerfile \
            --output type=docker,dest=/tmp/nta-auth-service.tar \
            .
          
          # Asset Service
          docker buildx build \
            --platform linux/amd64 \
            -t nta-asset-service:v2.0.0 \
            -f services/asset-service/Dockerfile \
            --output type=docker,dest=/tmp/nta-asset-service.tar \
            .
          
          # Detection Service
          docker buildx build \
            --platform linux/amd64 \
            -t nta-detection-service:v2.0.0 \
            -f services/detection-service/Dockerfile \
            --output type=docker,dest=/tmp/nta-detection-service.tar \
            .
          
          # Alert Service
          docker buildx build \
            --platform linux/amd64 \
            -t nta-alert-service:v2.0.0 \
            -f services/alert-service/Dockerfile \
            --output type=docker,dest=/tmp/nta-alert-service.tar \
            .
          
          # Report Service
          docker buildx build \
            --platform linux/amd64 \
            -t nta-report-service:v2.0.0 \
            -f services/report-service/Dockerfile \
            --output type=docker,dest=/tmp/nta-report-service.tar \
            .
          
          # Notification Service
          docker buildx build \
            --platform linux/amd64 \
            -t nta-notification-service:v2.0.0 \
            -f services/notification-service/Dockerfile \
            --output type=docker,dest=/tmp/nta-notification-service.tar \
            .
          
          # Probe Service
          docker buildx build \
            --platform linux/amd64 \
            -t nta-probe-service:v2.0.0 \
            -f services/probe-service/Dockerfile \
            --output type=docker,dest=/tmp/nta-probe-service.tar \
            .
          
          # Intel Service
          docker buildx build \
            --platform linux/amd64 \
            -t nta-intel-service:v2.0.0 \
            -f services/intel-service/Dockerfile \
            --output type=docker,dest=/tmp/nta-intel-service.tar \
            .
          


      - name: Build Traefik image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t nta-traefik:v2.0.0 \
            -f docker/traefik/Dockerfile \
            --output type=docker,dest=/tmp/nta-traefik.tar \
            .

      - name: Build zeek image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t nta-zeek:v1.0.0 \
            --output type=docker,dest=/tmp/nta-zeek.tar \
            ./docker/zeek

      - name: Pull third-party images
        run: |
          docker pull --platform linux/amd64 postgres:15-alpine
          docker pull --platform linux/amd64 redis:7-alpine
          docker pull --platform linux/amd64 prom/prometheus:latest
          docker pull --platform linux/amd64 grafana/grafana:latest
          docker pull --platform linux/amd64 zookeeper:3.9
          docker pull --platform linux/amd64 confluentinc/cp-kafka:7.5.0
          docker pull --platform linux/amd64 flink:1.18-scala_2.12-java11
          docker pull --platform linux/amd64 hashicorp/consul:1.17
          docker pull --platform linux/amd64 jaegertracing/all-in-one:1.51

      - name: Save third-party images
        run: |
          docker save postgres:15-alpine -o /tmp/postgres.tar
          docker save redis:7-alpine -o /tmp/redis.tar
          docker save prom/prometheus:latest -o /tmp/prometheus.tar
          docker save grafana/grafana:latest -o /tmp/grafana.tar
          docker save zookeeper:3.9 -o /tmp/zookeeper.tar
          docker save confluentinc/cp-kafka:7.5.0 -o /tmp/kafka.tar
          docker save flink:1.18-scala_2.12-java11 -o /tmp/flink.tar
          docker save hashicorp/consul:1.17 -o /tmp/consul.tar
          docker save jaegertracing/all-in-one:1.51 -o /tmp/jaeger.tar

      - name: Download Docker offline packages
        run: |
          mkdir -p /tmp/docker-packages
          
          # Download Docker Engine for CentOS/AliyunOS
          curl -fsSL https://download.docker.com/linux/static/stable/x86_64/docker-${{ env.DOCKER_VERSION }}.tgz \
            -o /tmp/docker-packages/docker-${{ env.DOCKER_VERSION }}.tgz
          
          # Download Docker Compose
          curl -fsSL https://github.com/docker/compose/releases/download/v${{ env.DOCKER_COMPOSE_VERSION }}/docker-compose-linux-x86_64 \
            -o /tmp/docker-packages/docker-compose
          chmod +x /tmp/docker-packages/docker-compose
          
          # Download containerd
          curl -fsSL https://github.com/containerd/containerd/releases/download/v${{ env.CONTAINERD_VERSION }}/containerd-${{ env.CONTAINERD_VERSION }}-linux-amd64.tar.gz \
            -o /tmp/docker-packages/containerd.tar.gz

      - name: Create deployment scripts
        run: |
          mkdir -p /tmp/nta-deploy
          
          # Create install.sh
          cat > /tmp/nta-deploy/install.sh <<'INSTALL_EOF'
          #!/bin/bash
          set -e

          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          DOCKER_VERSION="24.0.7"
          COMPOSE_VERSION="2.24.0"

          # Color output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m'

          log_info() {
              echo -e "${GREEN}[ä¿¡æ¯]${NC} $1"
          }

          log_warn() {
              echo -e "${YELLOW}[è­¦å‘Š]${NC} $1"
          }

          log_error() {
              echo -e "${RED}[é”™è¯¯]${NC} $1"
          }

          # Detect OS
          detect_os() {
              if [ -f /etc/os-release ]; then
                  . /etc/os-release
                  OS=$ID
                  VERSION_ID=$VERSION_ID
              else
                  log_error "æ— æ³•æ£€æµ‹æ“ä½œç³»ç»Ÿ"
                  exit 1
              fi
              
              log_info "æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS $VERSION_ID"
          }

          # Check system requirements
          check_requirements() {
              log_info "æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿè¦æ±‚..."
              
              # Check CPU cores
              CPU_CORES=$(nproc)
              if [ "$CPU_CORES" -lt 2 ]; then
                  log_warn "CPU æ ¸å¿ƒæ•°: $CPU_CORES (æŽ¨è: >= 2)"
              else
                  log_info "CPU æ ¸å¿ƒæ•°: $CPU_CORES âœ“"
              fi
              
              # Check memory
              TOTAL_MEM=$(free -g | awk '/^Mem:/{print $2}')
              if [ "$TOTAL_MEM" -lt 4 ]; then
                  log_warn "å†…å­˜: ${TOTAL_MEM}GB (æŽ¨è: >= 4GB)"
              else
                  log_info "å†…å­˜: ${TOTAL_MEM}GB âœ“"
              fi
              
              # Check disk space
              DISK_SPACE=$(df -BG "$SCRIPT_DIR" | tail -1 | awk '{print $4}' | sed 's/G//')
              if [ "$DISK_SPACE" -lt 50 ]; then
                  log_warn "ç£ç›˜ç©ºé—´: ${DISK_SPACE}GB (æŽ¨è: >= 50GB)"
              else
                  log_info "ç£ç›˜ç©ºé—´: ${DISK_SPACE}GB âœ“"
              fi
          }

          # Install Docker
          install_docker() {
              if command -v docker &> /dev/null; then
                  INSTALLED_VERSION=$(docker --version | grep -oP '\d+\.\d+\.\d+' | head -1)
                  log_info "Docker å·²å®‰è£…: $INSTALLED_VERSION"
                  return 0
              fi
              
              log_info "æ­£åœ¨å®‰è£… Docker $DOCKER_VERSION..."
              
              cd "$SCRIPT_DIR/docker-packages"
              tar xzf docker-${DOCKER_VERSION}.tgz
              
              # Copy binaries
              cp docker/* /usr/bin/
              
              # Create systemd service
              tee /etc/systemd/system/docker.service > /dev/null <<'DOCKER_SERVICE'
          [Unit]
          Description=Docker Application Container Engine
          Documentation=https://docs.docker.com
          After=network-online.target firewalld.service containerd.service docker.socket
          Wants=network-online.target
          Requires=docker.socket containerd.service

          [Service]
          Type=notify
          ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
          ExecReload=/bin/kill -s HUP $MAINPID
          TimeoutSec=0
          RestartSec=2
          Restart=always
          StartLimitBurst=3
          StartLimitInterval=60s
          LimitNOFILE=infinity
          LimitNPROC=infinity
          LimitCORE=infinity
          TasksMax=infinity
          Delegate=yes
          KillMode=process

          [Install]
          WantedBy=multi-user.target
          DOCKER_SERVICE
              
              # Create docker socket
              tee /etc/systemd/system/docker.socket > /dev/null <<'DOCKER_SOCKET'
          [Unit]
          Description=Docker Socket for the API
          PartOf=docker.service

          [Socket]
          ListenStream=/var/run/docker.sock
          SocketMode=0660
          SocketUser=root
          SocketGroup=docker

          [Install]
          WantedBy=sockets.target
          DOCKER_SOCKET
              
              # Install containerd
              if ! command -v containerd &> /dev/null; then
                  log_info "æ­£åœ¨å®‰è£… containerd..."
                  if [ -f "$SCRIPT_DIR/docker-packages/containerd.tar.gz" ]; then
                      tar -xz -C /usr/local -f "$SCRIPT_DIR/docker-packages/containerd.tar.gz"
                  else
                      log_error "docker-packages/ ç›®å½•ä¸‹æœªæ‰¾åˆ° containerd.tar.gz"
                      exit 1
                  fi
                  
                  tee /etc/systemd/system/containerd.service > /dev/null <<'CONTAINERD_SERVICE'
          [Unit]
          Description=containerd container runtime
          Documentation=https://containerd.io
          After=network.target

          [Service]
          ExecStartPre=/sbin/modprobe overlay
          ExecStart=/usr/local/bin/containerd
          Restart=always
          RestartSec=5
          Delegate=yes
          KillMode=process
          OOMScoreAdjust=-999
          LimitNOFILE=1048576
          LimitNPROC=infinity
          LimitCORE=infinity
          TasksMax=infinity

          [Install]
          WantedBy=multi-user.target
          CONTAINERD_SERVICE
              fi
              
              # Create docker group
              if ! getent group docker > /dev/null 2>&1; then
                  log_info "æ­£åœ¨åˆ›å»º docker ç”¨æˆ·ç»„..."
                  groupadd docker
              fi
              
              # Start services
              systemctl daemon-reload
              systemctl enable containerd docker.socket docker
              systemctl start containerd docker.socket docker
              
              log_info "Docker å®‰è£…æˆåŠŸ âœ“"
          }

          # Install Docker Compose
          install_docker_compose() {
              if command -v docker-compose &> /dev/null; then
                  INSTALLED_VERSION=$(docker-compose --version | grep -oP '\d+\.\d+\.\d+' | head -1)
                  log_info "Docker Compose å·²å®‰è£…: $INSTALLED_VERSION"
                  return 0
              fi
              
              log_info "æ­£åœ¨å®‰è£… Docker Compose $COMPOSE_VERSION..."
              
              cp "$SCRIPT_DIR/docker-packages/docker-compose" /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              
              log_info "Docker Compose å®‰è£…æˆåŠŸ âœ“"
          }

          # Load Docker images
          load_images() {
              log_info "æ­£åœ¨åŠ è½½ Docker é•œåƒ (å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)..."
              
              cd "$SCRIPT_DIR/images"
              for image in *.tar; do
                  log_info "æ­£åœ¨åŠ è½½ $image..."
                  docker load -i "$image"
              done
              
              log_info "æ‰€æœ‰é•œåƒåŠ è½½æˆåŠŸ âœ“"
          }

          # Configure firewall
          configure_firewall() {
              log_info "æ­£åœ¨é…ç½®é˜²ç«å¢™..."
              
              if command -v firewall-cmd &> /dev/null; then
                  if systemctl is-active --quiet firewalld; then
                      firewall-cmd --permanent --add-port=80/tcp 2>/dev/null || log_warn "æ·»åŠ ç«¯å£å¤±è´¥ 80"
                      firewall-cmd --permanent --add-port=3000/tcp 2>/dev/null || log_warn "æ·»åŠ ç«¯å£å¤±è´¥ 3000"
                      firewall-cmd --permanent --add-port=9090/tcp 2>/dev/null || log_warn "æ·»åŠ ç«¯å£å¤±è´¥ 9090"
                      firewall-cmd --reload 2>/dev/null || log_warn "é‡è½½é˜²ç«å¢™å¤±è´¥"
                      log_info "é˜²ç«å¢™é…ç½®æˆåŠŸ (firewalld) âœ“"
                  else
                      log_warn "firewalld æœåŠ¡æœªè¿è¡Œï¼Œè·³è¿‡é˜²ç«å¢™é…ç½®"
                  fi
              elif command -v ufw &> /dev/null; then
                  if systemctl is-active --quiet ufw 2>/dev/null || ufw status 2>/dev/null | grep -q "Status: active"; then
                      ufw allow 80/tcp 2>/dev/null || log_warn "æ·»åŠ ç«¯å£å¤±è´¥ 80"
                      ufw allow 3000/tcp 2>/dev/null || log_warn "æ·»åŠ ç«¯å£å¤±è´¥ 3000"
                      ufw allow 9090/tcp 2>/dev/null || log_warn "æ·»åŠ ç«¯å£å¤±è´¥ 9090"
                      log_info "é˜²ç«å¢™é…ç½®æˆåŠŸ (ufw) âœ“"
                  else
                      log_warn "ufw æœåŠ¡æœªæ¿€æ´»ï¼Œè·³è¿‡é˜²ç«å¢™é…ç½®"
                  fi
              else
                  log_warn "æœªæ£€æµ‹åˆ°é˜²ç«å¢™ï¼Œè·³è¿‡"
              fi
          }

          # Create configuration
          create_config() {
              log_info "æ­£åœ¨åˆ›å»ºé…ç½®æ–‡ä»¶..."
              
              mkdir -p "$SCRIPT_DIR/config"
              
              if [ ! -f "$SCRIPT_DIR/config/nta.yaml" ]; then
                  cp "$SCRIPT_DIR/config/nta.yaml.example" "$SCRIPT_DIR/config/nta.yaml"
                  log_info "å·²åˆ›å»º config/nta.yaml"
              fi
              
              # Generate random JWT secret
              JWT_SECRET=$(openssl rand -base64 32 2>/dev/null || cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1)
              sed -i "s|CHANGE_THIS_SECRET_KEY_MIN_32_CHARACTERS_LONG|$JWT_SECRET|g" "$SCRIPT_DIR/config/nta.yaml"
              
              # Fix database and redis addresses for Docker container networking
              log_info "æ­£åœ¨é…ç½®å®¹å™¨ç½‘ç»œ..."
              
              # Fix PostgreSQL hostname - ensure using container name
              if grep -q "host=localhost" "$SCRIPT_DIR/config/nta.yaml"; then
                  sed -i 's/host=localhost/host=nta-postgres/g' "$SCRIPT_DIR/config/nta.yaml"
                  log_info "ä¿®å¤æ•°æ®åº“åœ°å€: localhost -> nta-postgres"
              fi
              if grep -q "host=postgres " "$SCRIPT_DIR/config/nta.yaml"; then
                  sed -i 's/host=postgres /host=nta-postgres /g' "$SCRIPT_DIR/config/nta.yaml"
                  log_info "ä¿®å¤æ•°æ®åº“åœ°å€: postgres -> nta-postgres"
              fi
              
              # Fix Redis hostname - ensure using container name
              if grep -q "addr: localhost:6379" "$SCRIPT_DIR/config/nta.yaml"; then
                  sed -i 's/addr: localhost:6379/addr: nta-redis:6379/g' "$SCRIPT_DIR/config/nta.yaml"
                  log_info "ä¿®å¤ Redis åœ°å€: localhost -> nta-redis"
              fi
              if grep -q "addr: redis:6379" "$SCRIPT_DIR/config/nta.yaml"; then
                  sed -i 's/addr: redis:6379/addr: nta-redis:6379/g' "$SCRIPT_DIR/config/nta.yaml"
                  log_info "ä¿®å¤ Redis åœ°å€: redis -> nta-redis"
              fi
              
              log_info "é…ç½®åˆ›å»ºæˆåŠŸ âœ“"
          }
          
          # Verify container networking
          verify_network() {
              log_info "æ­£åœ¨éªŒè¯å®¹å™¨ç½‘ç»œé…ç½®..."
              
              # Check if nta-postgres is reachable from nta-server
              if docker exec nta-server ping -c 2 nta-postgres > /dev/null 2>&1; then
                  log_info "âœ“ nta-server å¯ä»¥è®¿é—® nta-postgres"
              else
                  log_warn "âœ— nta-server æ— æ³•è®¿é—® nta-postgres (å®¹å™¨å¯èƒ½ä»åœ¨å¯åŠ¨ä¸­)"
              fi
              
              # Check if nta-redis is reachable from nta-server
              if docker exec nta-server ping -c 2 nta-redis > /dev/null 2>&1; then
                  log_info "âœ“ nta-server å¯ä»¥è®¿é—® nta-redis"
              else
                  log_warn "âœ— nta-server æ— æ³•è®¿é—® nta-redis (å®¹å™¨å¯èƒ½ä»åœ¨å¯åŠ¨ä¸­)"
              fi
          }

          # Deploy NTA
          deploy_nta() {
              log_info "æ­£åœ¨éƒ¨ç½² NTA ç³»ç»Ÿ..."
              
              cd "$SCRIPT_DIR"
              
              # Verify docker-compose.yml exists
              if [ ! -f docker-compose.yml ]; then
                  log_error "æœªåœ¨ä»¥ä¸‹ç›®å½•æ‰¾åˆ° docker-compose.yml: $SCRIPT_DIR"
                  exit 1
              fi
              
              # Verify config exists
              if [ ! -f config/nta.yaml ]; then
                  log_error "æœªæ‰¾åˆ° config/nta.yaml"
                  exit 1
              fi
              
              # Verify config content
              log_info "æ­£åœ¨éªŒè¯é…ç½®..."
              if grep -q "host=localhost" config/nta.yaml; then
                  log_error "é…ç½®åŒ…å« 'host=localhost' - è¿™åœ¨ Docker ä¸­ä¼šå¤±è´¥"
                  log_error "æœŸæœ› 'host=nta-postgres'"
                  cat config/nta.yaml | grep -E "(dsn|addr)" | head -5
                  exit 1
              fi
              if grep -q "addr: localhost:6379" config/nta.yaml; then
                  log_error "é…ç½®åŒ…å« 'addr: localhost:6379' - è¿™åœ¨ Docker ä¸­ä¼šå¤±è´¥"
                  log_error "æœŸæœ› 'addr: nta-redis:6379'"
                  cat config/nta.yaml | grep -E "(dsn|addr)" | head -5
                  exit 1
              fi
              log_info "é…ç½®éªŒè¯æˆåŠŸ âœ“"
              log_info "  æ•°æ®åº“: $(grep 'dsn:' config/nta.yaml | head -1)"
              log_info "  Redis:    $(grep 'addr:' config/nta.yaml | head -1)"
              
              export VERSION="${VERSION:-dev}"
              export BUILD_TIME="${BUILD_TIME:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}"
              export GIT_COMMIT="${GIT_COMMIT:-unknown}"
              
              log_info "æ­£åœ¨å¯åŠ¨ Docker Compose..."
              docker-compose up -d
              
              if [ $? -ne 0 ]; then
                  log_error "docker-compose up å¤±è´¥"
                  exit 1
              fi
              
              log_info "å®¹å™¨å·²å¯åŠ¨ï¼Œç­‰å¾…åˆå§‹åŒ–..."
              sleep 5
              
              # Verify network exists
              if docker network ls | grep -q "nta.*network"; then
                  log_info "Docker ç½‘ç»œåˆ›å»ºæˆåŠŸ âœ“"
              else
                  log_warn "æœªæ‰¾åˆ° NTA ç½‘ç»œï¼Œå®¹å™¨å¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜"
              fi
              
              log_info "NTA éƒ¨ç½²å·²å¯åŠ¨ âœ“"
          }

          # Check deployment
          check_deployment() {
              log_info "æ­£åœ¨æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
              
              log_info "ç­‰å¾…å®¹å™¨å¯åŠ¨..."
              sleep 10
              
              # Show all container status
              log_info "å®¹å™¨çŠ¶æ€:"
              docker ps -a --filter "name=nta-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              echo ""
              
              # Check if nta-server container exists
              if ! docker ps -a | grep -q "nta-server"; then
                  log_error "æœªæ‰¾åˆ° nta-server å®¹å™¨"
                  log_info "å¯ç”¨å®¹å™¨:"
                  docker ps -a
                  exit 1
              fi
              
              # Check if nta-server is restarting
              if docker ps -a | grep "nta-server" | grep -q "Restarting"; then
                  log_error "nta-server å®¹å™¨æ­£åœ¨é‡å¯ - æ£€æµ‹åˆ°é…ç½®é—®é¢˜"
                  echo ""
                  log_info "nta-server æœ€è¿‘çš„æ—¥å¿—:"
                  docker logs nta-server --tail 100 2>&1 || true
                  echo ""
                  log_error "å¸¸è§é—®é¢˜:"
                  log_error "  1. æ•°æ®åº“è¿žæŽ¥å¤±è´¥ - æ£€æŸ¥ postgres å®¹å™¨æ˜¯å¦å¥åº·"
                  log_error "  2. Redis è¿žæŽ¥å¤±è´¥ - æ£€æŸ¥ redis å®¹å™¨æ˜¯å¦å¥åº·"
                  log_error "  3. é…ç½®æ–‡ä»¶é—®é¢˜ - éªŒè¯ config/nta.yaml"
                  echo ""
                  log_info "æ•…éšœæŽ’æŸ¥æ­¥éª¤:"
                  log_info "  1. æ£€æŸ¥æ•°æ®åº“: docker logs nta-postgres"
                  log_info "  2. æ£€æŸ¥ Redis: docker logs nta-redis"
                  log_info "  3. æ£€æŸ¥ç½‘ç»œ: docker network inspect nta_nta-network"
                  log_info "  4. éªŒè¯é…ç½®: cat config/nta.yaml | grep -E '(dsn|addr)'"
                  exit 1
              fi
              
              # Wait for nta-server to be Up
              log_info "ç­‰å¾… nta-server å¥åº·æ£€æŸ¥..."
              local wait_attempts=30
              local wait_count=0
              
              while [ $wait_count -lt $wait_attempts ]; do
                  if docker ps | grep "nta-server" | grep -q "Up"; then
                      log_info "nta-server æ­£åœ¨è¿è¡Œ"
                      break
                  fi
                  wait_count=$((wait_count + 1))
                  echo -n "."
                  sleep 2
              done
              echo ""
              
              if [ $wait_count -ge $wait_attempts ]; then
                  log_error "nta-server åœ¨ 60 ç§’å†…æœªèƒ½å¯åŠ¨"
                  docker logs nta-server --tail 100 2>&1 || true
                  exit 1
              fi
              
              # Verify network connectivity
              sleep 3
              verify_network
              
              # Wait for health check endpoint
              log_info "ç­‰å¾… API å¥åº·æ£€æŸ¥..."
              local max_attempts=30
              local attempt=0
              
              while [ $attempt -lt $max_attempts ]; do
                  if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
                      log_info "NTA ç³»ç»Ÿå¥åº· âœ“"
                      echo ""
                      log_info "========================================="
                      log_info "  NTA ç³»ç»Ÿéƒ¨ç½²æˆåŠŸ!"
                      log_info "========================================="
                      echo ""
                      log_info "è®¿é—®åœ°å€:"
                      log_info "  Web ç•Œé¢:      http://$(hostname -I | awk '{print $1}')/"
                      log_info "  API æœåŠ¡å™¨:  http://$(hostname -I | awk '{print $1}'):8080"
                      log_info "  å¥åº·æ£€æŸ¥ API:  http://$(hostname -I | awk '{print $1}'):8080/health"
                      echo ""
                      log_info "ç›‘æŽ§:"
                      log_info "  Grafana:     http://$(hostname -I | awk '{print $1}'):3000 (admin/admin)"
                      log_info "  Prometheus:  http://$(hostname -I | awk '{print $1}'):9090"
                      echo ""
                      log_info "ç®¡ç†å‘½ä»¤:"
                      log_info "  æŸ¥çœ‹æ—¥å¿—:       docker logs -f nta-server"
                      log_info "  æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—:   docker-compose logs -f"
                      log_info "  é‡å¯æœåŠ¡: docker-compose restart nta-server"
                      log_info "  åœæ­¢æ‰€æœ‰:        docker-compose down"
                      log_info "  å¯åŠ¨æ‰€æœ‰:       docker-compose up -d"
                      echo ""
                      log_info "é»˜è®¤å‡­æ®: admin / admin"
                      echo ""
                      return 0
                  fi
                  attempt=$((attempt + 1))
                  echo -n "."
                  sleep 2
              done
              
              echo ""
              log_error "NTA API å¥åº·æ£€æŸ¥åœ¨ 60 ç§’åŽå¤±è´¥"
              echo ""
              log_info "æœ€ç»ˆå®¹å™¨çŠ¶æ€:"
              docker ps -a --filter "name=nta-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              echo ""
              log_info "nta-server æ—¥å¿—:"
              docker logs nta-server --tail 100 2>&1 || true
              echo ""
              log_warn "ç³»ç»Ÿå¯èƒ½ä»åœ¨å¯åŠ¨ä¸­ã€‚æ‚¨å¯ä»¥:"
              log_warn "  1. å†ç­‰å¾…å‡ åˆ†é’Ÿå¹¶æ£€æŸ¥: curl http://localhost:8080/health"
              log_warn "  2. æ£€æŸ¥æ—¥å¿—: docker logs -f nta-server"
              log_warn "  3. é‡å¯: docker-compose restart nta-server"
              exit 1
          }

          # Main installation
          main() {
              echo ""
              log_info "========================================="
              log_info "  NTA ç¦»çº¿å®‰è£…"
              log_info "========================================="
              echo ""
              
              detect_os
              check_requirements
              install_docker
              install_docker_compose
              load_images
              configure_firewall
              create_config
              deploy_nta
              check_deployment
          }

          main "$@"
          INSTALL_EOF
          
          chmod +x /tmp/nta-deploy/install.sh

      - name: Create uninstall script
        run: |
          cat > /tmp/nta-deploy/uninstall.sh <<'UNINSTALL_EOF'
          #!/bin/bash
          set -e

          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

          RED='\033[0;31m'
          YELLOW='\033[1;33m'
          NC='\033[0m'

          log_warn() {
              echo -e "${YELLOW}[WARN]${NC} $1"
          }

          log_error() {
              echo -e "${RED}[ERROR]${NC} $1"
          }

          echo ""
          log_warn "========================================="
          log_warn "  NTA å¸è½½"
          log_warn "========================================="
          echo ""
          log_warn "è¿™å°†åˆ é™¤ NTA ç³»ç»Ÿå’Œæ‰€æœ‰æ•°æ®ï¼"
          read -p "æ˜¯å¦ç»§ç»­ï¼Ÿ (yes/no): " CONFIRM

          if [ "$CONFIRM" != "yes" ]; then
              log_error "å·²å–æ¶ˆ"
              exit 1
          fi

          cd "$SCRIPT_DIR"

          log_warn "æ­£åœ¨åœæ­¢æœåŠ¡..."
          docker-compose down -v

          log_warn "æ­£åœ¨åˆ é™¤é•œåƒ..."
          docker rmi nta-server:v1.0.0 nta-web:v1.0.0 postgres:15-alpine redis:7-alpine prom/prometheus:latest grafana/grafana:latest 2>/dev/null || true

          echo ""
          log_warn "NTA å·²å¸è½½ã€‚Docker å’Œ Docker Compose ä»ç„¶ä¿ç•™ã€‚"
          log_warn "è¦å®Œå…¨åˆ é™¤ Dockerï¼Œè¯·è¿è¡Œ: sudo apt remove docker-ce docker-ce-cli (Ubuntu) or sudo yum remove docker-ce (CentOS)"
          UNINSTALL_EOF
          
          chmod +x /tmp/nta-deploy/uninstall.sh

      - name: Create README
        run: |
          cat > /tmp/nta-deploy/README.md <<'README_EOF'
          # NTA ç¦»çº¿éƒ¨ç½²åŒ…

          ## ç³»ç»Ÿè¦æ±‚

          - **æ“ä½œç³»ç»Ÿ**: CentOS 7+, Ubuntu 20.04+, Anolis OS 8
          - **æž¶æž„**: x86_64 (64ä½)
          - **CPU**: 2æ ¸åŠä»¥ä¸Š
          - **å†…å­˜**: 4GBåŠä»¥ä¸Š
          - **ç£ç›˜**: 50GBåŠä»¥ä¸Šå¯ç”¨ç©ºé—´

          ## éƒ¨ç½²æ­¥éª¤

          ### 1. è§£åŽ‹éƒ¨ç½²åŒ…
          ```bash
          unzip nta-offline-deploy-*.zip
          cd nta-offline-deploy
          ```

          ### 2. è¿è¡Œå®‰è£…è„šæœ¬
          ```bash
          sudo bash install.sh
          ```

          å®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
          - æ£€æµ‹ç³»ç»ŸçŽ¯å¢ƒ
          - å®‰è£… Docker å’Œ Docker Compose
          - åŠ è½½æ‰€æœ‰é•œåƒ
          - é…ç½®é˜²ç«å¢™
          - å¯åŠ¨ NTA ç³»ç»Ÿ

          ### 3. è®¿é—®ç³»ç»Ÿ
          ```
          å‰ç«¯: http://YOUR_SERVER_IP/
          Grafana: http://YOUR_SERVER_IP:3000
          Prometheus: http://YOUR_SERVER_IP:9090
          ```

          é»˜è®¤ç™»å½•è´¦å·: `admin` / `admin`

          ## å¸¸ç”¨å‘½ä»¤

          ### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
          ```bash
          docker-compose ps
          ```

          ### æŸ¥çœ‹æ—¥å¿—
          ```bash
          docker-compose logs -f
          docker-compose logs -f nta-server
          ```

          ### é‡å¯æœåŠ¡
          ```bash
          docker-compose restart
          ```

          ### åœæ­¢æœåŠ¡
          ```bash
          docker-compose down
          ```

          ### å¯åŠ¨æœåŠ¡
          ```bash
          docker-compose up -d
          ```

          ## å¸è½½

          ```bash
          sudo bash uninstall.sh
          ```

          ## ç›®å½•ç»“æž„

          ```
          nta-offline-deploy/
          â”œâ”€â”€ install.sh              # å®‰è£…è„šæœ¬
          â”œâ”€â”€ uninstall.sh            # å¸è½½è„šæœ¬
          â”œâ”€â”€ docker-compose.yml      # Dockerç¼–æŽ’é…ç½®
          â”œâ”€â”€ images/                 # Dockeré•œåƒæ–‡ä»¶
          â”‚   â”œâ”€â”€ nta-server.tar
          â”‚   â”œâ”€â”€ nta-web.tar
          â”‚   â”œâ”€â”€ postgres.tar
          â”‚   â”œâ”€â”€ redis.tar
          â”‚   â”œâ”€â”€ prometheus.tar
          â”‚   â””â”€â”€ grafana.tar
          â”œâ”€â”€ docker-packages/        # Dockerç¦»çº¿å®‰è£…åŒ…
          â”‚   â”œâ”€â”€ docker-24.0.7.tgz
          â”‚   â””â”€â”€ docker-compose
          â”œâ”€â”€ config/                 # é…ç½®æ–‡ä»¶
          â”‚   â””â”€â”€ nta.yaml.example
          â”œâ”€â”€ deploy/                 # éƒ¨ç½²é…ç½®
          â””â”€â”€ README.md
          ```

          ## é…ç½®è¯´æ˜Ž

          ä¸»é…ç½®æ–‡ä»¶: `config/nta.yaml`

          **é‡è¦é…ç½®é¡¹**:
          - `server.host`: ç›‘å¬åœ°å€ (é»˜è®¤ 0.0.0.0)
          - `server.port`: ç›‘å¬ç«¯å£ (é»˜è®¤ 8080)
          - `database.dsn`: æ•°æ®åº“è¿žæŽ¥ä¸²
          - `security.jwt_secret`: JWTå¯†é’¥ (è‡ªåŠ¨ç”Ÿæˆ)

          ## æ•…éšœæŽ’æŸ¥

          ### æ£€æŸ¥å®¹å™¨çŠ¶æ€
          ```bash
          docker-compose ps
          ```

          ### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
          ```bash
          docker-compose logs --tail=100
          ```

          ### å¥åº·æ£€æŸ¥
          ```bash
          curl http://localhost/health
          curl http://localhost/api/v1/health
          ```

          ### ç«¯å£æ£€æŸ¥
          ```bash
          netstat -tulnp | grep -E '80|8080|5432|6379'
          ```

          ## æŠ€æœ¯æ”¯æŒ

          - æ–‡æ¡£: `/root/NTA/docs/`
          - é—®é¢˜åé¦ˆ: GitHub Issues
          README_EOF

      - name: Copy deployment files
        run: |
          # Copy docker-compose.yml
          cp docker-compose.yml /tmp/nta-deploy/
          
          # Copy config files
          mkdir -p /tmp/nta-deploy/config
          cat > /tmp/nta-deploy/config/nta.yaml.example <<'CONFIG_EOF'
          server:
            host: 0.0.0.0
            port: 8080
            mode: release

          zeek:
            log_dir: /var/spool/zeek
            script_dir: /app/zeek-scripts
            interface: eth0

          database:
            type: postgres
            dsn: "host=nta-postgres user=nta password=nta_password dbname=nta port=5432 sslmode=disable"

          redis:
            addr: nta-redis:6379
            password: ""
            db: 0

          security:
            jwt_secret: "CHANGE_THIS_SECRET_KEY_MIN_32_CHARACTERS_LONG"
            enable_tls: false
            tls_cert_file: ""
            tls_key_file: ""
            rate_limit_requests: 100
            rate_limit_window: 60
            allowed_origins:
              - "*"

          detection:
            scan:
              threshold: 20
              time_window: 300
              min_fail_rate: 0.6
            auth:
              fail_threshold: 5
              pth_window: 3600
            ml:
              enabled: true
              contamination: 0.01

          threat_intel:
            sources:
              - name: threatfox
                url: https://threatfox-api.abuse.ch/api/v1/
                api_key: ""
                enabled: true
            update_interval: 3600
            local_feed_path: /app/config/threat_feed.json

          license:
            license_file: /app/config/license.key
            public_key_file: /app/config/public.pem

          backup:
            enabled: false
            backup_dir: /app/backups
            interval_hours: 24
            retention_days: 7
          CONFIG_EOF
          
          # Also copy other config files from source repo
          if [ -f config/threat_feed.json ]; then
              cp config/threat_feed.json /tmp/nta-deploy/config/
          fi
          if [ -f config/apt_iocs.json ]; then
              cp config/apt_iocs.json /tmp/nta-deploy/config/
          fi
          
          # Copy deploy files
          mkdir -p /tmp/nta-deploy/deploy
          cp -r deploy/* /tmp/nta-deploy/deploy/ 2>/dev/null || true

      - name: Organize package structure
        run: |
          mkdir -p /tmp/nta-deploy/images
          mkdir -p /tmp/nta-deploy/docker-packages
          
          # Move application images
          mv /tmp/nta-server.tar /tmp/nta-deploy/images/
          mv /tmp/nta-web.tar /tmp/nta-deploy/images/
          mv /tmp/nta-zeek.tar /tmp/nta-deploy/images/
          
          # Move microservices images
          mv /tmp/nta-auth-service.tar /tmp/nta-deploy/images/
          mv /tmp/nta-asset-service.tar /tmp/nta-deploy/images/
          mv /tmp/nta-detection-service.tar /tmp/nta-deploy/images/
          mv /tmp/nta-alert-service.tar /tmp/nta-deploy/images/
          mv /tmp/nta-report-service.tar /tmp/nta-deploy/images/
          mv /tmp/nta-notification-service.tar /tmp/nta-deploy/images/
          mv /tmp/nta-probe-service.tar /tmp/nta-deploy/images/
          mv /tmp/nta-intel-service.tar /tmp/nta-deploy/images/
          mv /tmp/nta-traefik.tar /tmp/nta-deploy/images/
          
          # Move infrastructure images
          mv /tmp/postgres.tar /tmp/nta-deploy/images/
          mv /tmp/redis.tar /tmp/nta-deploy/images/
          mv /tmp/prometheus.tar /tmp/nta-deploy/images/
          mv /tmp/grafana.tar /tmp/nta-deploy/images/
          mv /tmp/zookeeper.tar /tmp/nta-deploy/images/
          mv /tmp/kafka.tar /tmp/nta-deploy/images/
          mv /tmp/flink.tar /tmp/nta-deploy/images/
          mv /tmp/consul.tar /tmp/nta-deploy/images/
          mv /tmp/jaeger.tar /tmp/nta-deploy/images/
          
          # Move docker packages
          mv /tmp/docker-packages/* /tmp/nta-deploy/docker-packages/

      - name: Create deployment package
        run: |
          cd /tmp
          PACKAGE_NAME="nta-offline-deploy-${{ env.VERSION }}-$(date +%Y%m%d)"
          mv nta-deploy "$PACKAGE_NAME"
          zip -r "${PACKAGE_NAME}.zip" "$PACKAGE_NAME"
          
          # Calculate checksum
          sha256sum "${PACKAGE_NAME}.zip" > "${PACKAGE_NAME}.zip.sha256"
          
          # Get package size
          PACKAGE_SIZE=$(du -h "${PACKAGE_NAME}.zip" | cut -f1)
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
          echo "PACKAGE_SIZE=${PACKAGE_SIZE}" >> $GITHUB_ENV

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: |
            /tmp/${{ env.PACKAGE_NAME }}.zip
            /tmp/${{ env.PACKAGE_NAME }}.zip.sha256
          retention-days: 30

      - name: Generate deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸŽ‰ NTA ç¦»çº¿éƒ¨ç½²åŒ…æž„å»ºå®Œæˆ

          ### ðŸ“¦ åŒ…ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ env.VERSION }}
          - **æž„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}
          - **Git Commit**: ${{ env.GIT_COMMIT }}
          - **åŒ…å¤§å°**: ${{ env.PACKAGE_SIZE }}
          - **åŒ…åç§°**: ${{ env.PACKAGE_NAME }}.zip

          ### ðŸ“¥ ä¸‹è½½åœ°å€
          åœ¨ Artifacts ä¸­ä¸‹è½½: \`${{ env.PACKAGE_NAME }}\`

          ### ðŸš€ éƒ¨ç½²è¯´æ˜Ž

          1. ä¸‹è½½å¹¶è§£åŽ‹éƒ¨ç½²åŒ…
          \`\`\`bash
          unzip ${{ env.PACKAGE_NAME }}.zip
          cd ${{ env.PACKAGE_NAME }}
          \`\`\`

          2. è¿è¡Œå®‰è£…è„šæœ¬
          \`\`\`bash
          sudo bash install.sh
          \`\`\`

          3. è®¿é—®ç³»ç»Ÿ
          \`\`\`
          http://YOUR_SERVER_IP/
          \`\`\`

          ### ðŸ“‹ åŒ…å«å†…å®¹
          - âœ… Docker 24.0.7 ç¦»çº¿å®‰è£…åŒ…
          - âœ… Docker Compose 2.23.0
          - âœ… NTA åŽç«¯é•œåƒ (nta-server)
          - âœ… NTA å‰ç«¯é•œåƒ (nta-web)
          - âœ… PostgreSQL 15 é•œåƒ
          - âœ… Redis 7 é•œåƒ
          - âœ… Prometheus é•œåƒ
          - âœ… Grafana é•œåƒ
          - âœ… ä¸€é”®å®‰è£…è„šæœ¬
          - âœ… é…ç½®æ–‡ä»¶æ¨¡æ¿
          - âœ… éƒ¨ç½²æ–‡æ¡£

          ### ðŸ–¥ï¸ æ”¯æŒå¹³å°
          - CentOS 7+
          - Ubuntu 20.04+
          - Anolis OS (é¾™èœ¥) 8
          - x86_64 æž¶æž„

          ### ðŸ“Š ç³»ç»Ÿè¦æ±‚
          - CPU: 2æ ¸+
          - å†…å­˜: 4GB+
          - ç£ç›˜: 50GB+
          EOF