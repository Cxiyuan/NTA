name: Build Offline Deployment Package

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  GO_VERSION: "1.23"
  NODE_VERSION: "20"
  ZEEK_VERSION: "6.0.3"
  POSTGRES_VERSION: "15.5"
  REDIS_VERSION: "7.2.3"
  KAFKA_VERSION: "3.6.1"

jobs:
  build-offline-package:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment variables
        run: |
          echo "BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "VERSION=$(git describe --tags --always || echo 'v2.0.0')" >> $GITHUB_ENV
          echo "GIT_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Verify Ubuntu version
        run: |
          . /etc/os-release
          echo "Building on: $PRETTY_NAME"
          if [ "$VERSION_ID" != "24.04" ]; then
            echo "ERROR: This workflow requires Ubuntu 24.04"
            exit 1
          fi

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake gcc g++ \
            libpcap-dev libssl-dev zlib1g-dev \
            libreadline-dev libncurses5-dev \
            python3 python3-pip \
            flex bison swig \
            libmaxminddb-dev libkrb5-dev \
            default-jdk

      - name: Build backend binary
        run: |
          mkdir -p /tmp/nta-build/bin
          
          # Download Go dependencies
          go mod download
          go mod tidy
          
          # Build main server
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-X main.Version=${{ env.VERSION }} -X main.BuildTime=${{ env.BUILD_TIME }} -X main.GitCommit=${{ env.GIT_COMMIT }}" \
            -o /tmp/nta-build/bin/nta-server \
            ./cmd/nta-server
          
          # Build kafka consumer
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build \
            -o /tmp/nta-build/bin/nta-kafka-consumer \
            ./cmd/kafka-consumer
          
          chmod +x /tmp/nta-build/bin/*
          
          echo "âœ… Go binaries built successfully"
          ls -lh /tmp/nta-build/bin/

      - name: Build frontend
        run: |
          cd web
          npm install
          npm run build
          
          # Copy frontend build to package
          mkdir -p /tmp/nta-build/web
          cp -r dist/* /tmp/nta-build/web/
          
          echo "âœ… Frontend built successfully"

      - name: Build PostgreSQL
        run: |
          echo "ğŸ”¨ Building PostgreSQL ${{ env.POSTGRES_VERSION }}..."
          
          cd /tmp
          wget https://ftp.postgresql.org/pub/source/v${{ env.POSTGRES_VERSION }}/postgresql-${{ env.POSTGRES_VERSION }}.tar.gz
          tar -xzf postgresql-${{ env.POSTGRES_VERSION }}.tar.gz
          cd postgresql-${{ env.POSTGRES_VERSION }}
          
          ./configure --prefix=/opt/postgres --with-openssl
          make -j$(nproc)
          
          # Install to temporary directory
          mkdir -p /tmp/postgres-install
          make DESTDIR=/tmp/postgres-install install
          
          # Create tarball
          mkdir -p /tmp/nta-build/depend
          cd /tmp/postgres-install
          tar -czf /tmp/nta-build/depend/postgresql-${{ env.POSTGRES_VERSION }}-ubuntu24.04-amd64.tar.gz opt/
          
          echo "âœ… PostgreSQL built and packaged"
          ls -lh /tmp/nta-build/depend/

      - name: Build Redis
        run: |
          echo "ğŸ”¨ Building Redis ${{ env.REDIS_VERSION }}..."
          
          cd /tmp
          wget https://download.redis.io/releases/redis-${{ env.REDIS_VERSION }}.tar.gz
          tar -xzf redis-${{ env.REDIS_VERSION }}.tar.gz
          cd redis-${{ env.REDIS_VERSION }}
          
          make -j$(nproc)
          
          # Install to temporary directory
          mkdir -p /tmp/redis-install/opt/redis
          make PREFIX=/tmp/redis-install/opt/redis install
          
          # Create tarball
          cd /tmp/redis-install
          tar -czf /tmp/nta-build/depend/redis-${{ env.REDIS_VERSION }}-ubuntu24.04-amd64.tar.gz opt/
          
          echo "âœ… Redis built and packaged"
          ls -lh /tmp/nta-build/depend/

      - name: Download and package Kafka
        run: |
          echo "ğŸ“¥ Downloading Kafka ${{ env.KAFKA_VERSION }}..."
          
          cd /tmp
          wget https://archive.apache.org/dist/kafka/${{ env.KAFKA_VERSION }}/kafka_2.13-${{ env.KAFKA_VERSION }}.tgz
          
          # Repackage for our directory structure
          mkdir -p /tmp/kafka-install/opt
          tar -xzf kafka_2.13-${{ env.KAFKA_VERSION }}.tgz
          mv kafka_2.13-${{ env.KAFKA_VERSION }} /tmp/kafka-install/opt/kafka
          
          # Create tarball
          cd /tmp/kafka-install
          tar -czf /tmp/nta-build/depend/kafka-${{ env.KAFKA_VERSION }}-bin.tar.gz opt/
          
          echo "âœ… Kafka packaged"
          ls -lh /tmp/nta-build/depend/

      - name: Build Zeek
        run: |
          echo "ğŸ”¨ Building Zeek ${{ env.ZEEK_VERSION }} (this will take 15-30 minutes)..."
          
          cd /tmp
          wget https://download.zeek.org/zeek-${{ env.ZEEK_VERSION }}.tar.gz
          tar -xzf zeek-${{ env.ZEEK_VERSION }}.tar.gz
          cd zeek-${{ env.ZEEK_VERSION }}
          
          ./configure --prefix=/opt/zeek
          make -j$(nproc)
          
          # Install to temporary directory
          mkdir -p /tmp/zeek-install
          make DESTDIR=/tmp/zeek-install install
          
          # Create tarball
          cd /tmp/zeek-install
          tar -czf /tmp/nta-build/depend/zeek-${{ env.ZEEK_VERSION }}-ubuntu24.04-amd64.tar.gz opt/
          
          echo "âœ… Zeek built and packaged"
          ls -lh /tmp/nta-build/depend/

      - name: Package configuration files
        run: |
          mkdir -p /tmp/nta-build/config
          mkdir -p /tmp/nta-build/scripts
          mkdir -p /tmp/nta-build/zeek-scripts
          
          # Copy configuration files
          cp -r config/* /tmp/nta-build/config/ || true
          
          # Copy zeek scripts
          cp -r zeek-scripts/* /tmp/nta-build/zeek-scripts/ || true
          
          # Copy deployment scripts
          cp install.sh /tmp/nta-build/
          cp uninstall.sh /tmp/nta-build/
          cp scripts/init-databases.sh /tmp/nta-build/scripts/ || true
          
          chmod +x /tmp/nta-build/*.sh
          chmod +x /tmp/nta-build/scripts/*.sh || true

      - name: Create offline package metadata
        run: |
          cat > /tmp/nta-build/VERSION.txt << EOF
          NTA Network Traffic Analysis System
          ==========================================
          Version: ${{ env.VERSION }}
          Build Time: ${{ env.BUILD_TIME }}
          Git Commit: ${{ env.GIT_COMMIT }}
          Build Environment: Ubuntu 24.04 LTS
          
          Components (Pre-compiled):
          - Go: ${{ env.GO_VERSION }}
          - Node.js: ${{ env.NODE_VERSION }}
          - PostgreSQL: ${{ env.POSTGRES_VERSION }} âœ… (pre-compiled)
          - Redis: ${{ env.REDIS_VERSION }} âœ… (pre-compiled)
          - Kafka: ${{ env.KAFKA_VERSION }} âœ… (pre-compiled)
          - Zeek: ${{ env.ZEEK_VERSION }} âœ… (pre-compiled)
          
          Target Platform: Ubuntu 24.04 LTS x86_64
          
          Notes:
          - All components are pre-compiled for Ubuntu 24.04
          - No compilation required during installation
          - Installation time: ~5-10 minutes
          - Package includes all dependencies in depend/ directory
          EOF
          
          cat > /tmp/nta-build/README.txt << EOF
          NTA ç¦»çº¿éƒ¨ç½²åŒ… - Ubuntu 24.04 LTS ä¸“ç”¨
          ==========================================
          
          âœ… æ‰€æœ‰ç»„ä»¶å·²é¢„ç¼–è¯‘ï¼Œæ— éœ€åœ¨ç›®æ ‡ç³»ç»Ÿç¼–è¯‘ï¼
          
          ç³»ç»Ÿè¦æ±‚:
          - æ“ä½œç³»ç»Ÿ: Ubuntu 24.04 LTS
          - æ¶æ„: x86_64 (amd64)
          - å†…å­˜: å»ºè®® 8GB+
          - CPU: å»ºè®® 4æ ¸+
          - ç£ç›˜: å»ºè®® 50GB+
          
          éƒ¨ç½²æ­¥éª¤:
          1. è§£å‹éƒ¨ç½²åŒ…: tar -xzf nta-offline-deploy-*.tar.gz
          2. è¿›å…¥ç›®å½•: cd nta-offline-deploy-*
          3. ä»¥ root æƒé™è¿è¡Œ: sudo bash install.sh
          4. ç­‰å¾…å®‰è£…å®Œæˆ (çº¦ 5-10 åˆ†é’Ÿ)
          5. æŒ‰ç…§æç¤ºå®Œæˆé…ç½®
          
          âš¡ å¿«é€Ÿå®‰è£…:
          - PostgreSQL: é¢„ç¼–è¯‘ï¼Œç›´æ¥è§£å‹å®‰è£…
          - Redis: é¢„ç¼–è¯‘ï¼Œç›´æ¥è§£å‹å®‰è£…
          - Kafka: Java äºŒè¿›åˆ¶ï¼Œç›´æ¥è§£å‹
          - Zeek: é¢„ç¼–è¯‘ï¼Œç›´æ¥è§£å‹å®‰è£…
          - æ€»å®‰è£…æ—¶é—´: çº¦ 5-10 åˆ†é’Ÿ (vs åŸæ¥çš„ 30-60 åˆ†é’Ÿ)
          
          é»˜è®¤è´¦æˆ·:
          - ç”¨æˆ·å: admin
          - å¯†ç : admin123
          
          è®¿é—®åœ°å€:
          - Webç•Œé¢: http://<æœåŠ¡å™¨IP>:8090
          - APIæœåŠ¡: http://<æœåŠ¡å™¨IP>:8080
          
          æ³¨æ„äº‹é¡¹:
          - æ‰€æœ‰ä¾èµ–å·²é¢„ç¼–è¯‘ï¼Œç›´æ¥è§£å‹å®‰è£…
          - ä»…éœ€å®‰è£…å°‘é‡ç³»ç»Ÿè¿è¡Œåº“ (libssl, libpcapç­‰)
          - Zeek æ¢é’ˆéœ€è¦åœ¨ Web ç•Œé¢æ‰‹åŠ¨é…ç½®åå¯åŠ¨
          - é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç 
          
          æ•…éšœæ’æŸ¥:
          - æŸ¥çœ‹å®‰è£…æ—¥å¿—: journalctl -xe
          - æŸ¥çœ‹æœåŠ¡çŠ¶æ€: systemctl status nta-server
          - æŸ¥çœ‹åº”ç”¨æ—¥å¿—: tail -f /var/log/nta/nta/nta-server.log
          
          å¸è½½ç³»ç»Ÿ:
          - è¿è¡Œ: sudo bash uninstall.sh
          EOF
          
          cat > /tmp/nta-build/depend/README.txt << EOF
          é¢„ç¼–è¯‘ä¾èµ–åŒ…ç›®å½•
          ==================
          
          æœ¬ç›®å½•åŒ…å«æ‰€æœ‰é¢„ç¼–è¯‘çš„åŸºç¡€è®¾æ–½ç»„ä»¶:
          
          1. postgresql-${{ env.POSTGRES_VERSION }}-ubuntu24.04-amd64.tar.gz
             - PostgreSQL æ•°æ®åº“
             - é¢„ç¼–è¯‘ï¼Œç›´æ¥è§£å‹åˆ° /opt/postgres
          
          2. redis-${{ env.REDIS_VERSION }}-ubuntu24.04-amd64.tar.gz
             - Redis ç¼“å­˜æœåŠ¡
             - é¢„ç¼–è¯‘ï¼Œç›´æ¥è§£å‹åˆ° /opt/redis
          
          3. kafka-${{ env.KAFKA_VERSION }}-bin.tar.gz
             - Kafka æ¶ˆæ¯é˜Ÿåˆ— (å« Zookeeper)
             - Java äºŒè¿›åˆ¶ï¼Œç›´æ¥è§£å‹åˆ° /opt/kafka
          
          4. zeek-${{ env.ZEEK_VERSION }}-ubuntu24.04-amd64.tar.gz
             - Zeek ç½‘ç»œæµé‡åˆ†æå¼•æ“
             - é¢„ç¼–è¯‘ï¼Œç›´æ¥è§£å‹åˆ° /opt/zeek
          
          æ‰€æœ‰åŒ…å‡åœ¨ Ubuntu 24.04 x86_64 ç¯å¢ƒä¸‹ç¼–è¯‘ï¼Œ
          ç¡®ä¿ä¸ç›®æ ‡ç³»ç»Ÿå®Œå…¨å…¼å®¹ã€‚
          EOF

      - name: Show package summary
        run: |
          echo "ğŸ“¦ Package Summary"
          echo "=================="
          echo ""
          echo "Binaries:"
          ls -lh /tmp/nta-build/bin/
          echo ""
          echo "Dependencies:"
          ls -lh /tmp/nta-build/depend/
          echo ""
          echo "Total size:"
          du -sh /tmp/nta-build/

      - name: Create deployment archive
        run: |
          cd /tmp
          tar -czf nta-offline-deploy-${{ env.GIT_COMMIT }}-$(date +%Y%m%d).tar.gz nta-build/
          
          # Calculate checksum
          sha256sum nta-offline-deploy-${{ env.GIT_COMMIT }}-$(date +%Y%m%d).tar.gz > nta-offline-deploy-${{ env.GIT_COMMIT }}-$(date +%Y%m%d).tar.gz.sha256
          
          # Show package info
          echo "ğŸ“¦ Final Package:"
          ls -lh nta-offline-deploy-*.tar.gz
          echo ""
          echo "ğŸ” Checksum:"
          cat nta-offline-deploy-*.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nta-offline-deploy-ubuntu-24.04-${{ env.GIT_COMMIT }}
          path: |
            /tmp/nta-offline-deploy-*.tar.gz
            /tmp/nta-offline-deploy-*.sha256
          retention-days: 30