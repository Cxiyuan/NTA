name: Build NTA Ubuntu 24.04 Release

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21.5'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake make gcc g++ flex bison libfl-dev \
            libpcap-dev libssl-dev zlib1g-dev \
            python3 python3-dev python3-pip \
            swig git wget curl tcpdump net-tools
      
      - name: Download and cache Zeek source
        id: cache-zeek-source
        uses: actions/cache@v4
        with:
          path: zeek-6.0.3.tar.gz
          key: zeek-6.0.3-source
      
      - name: Download Zeek source if not cached
        if: steps.cache-zeek-source.outputs.cache-hit != 'true'
        run: |
          wget https://download.zeek.org/zeek-6.0.3.tar.gz
      
      - name: Build Zeek
        run: |
          tar -xzf zeek-6.0.3.tar.gz
          cd zeek-6.0.3
          ./configure --prefix=/opt/zeek --build-type=Release
          make -j$(nproc)
          sudo make install
          cd ..
      
      - name: Package Zeek binary
        run: |
          cd /opt
          sudo tar -czf $GITHUB_WORKSPACE/zeek-6.0.3-ubuntu24.04-x64.tar.gz zeek
      
      - name: Build NTA Go binary
        run: |
          go mod download
          go build -o nta-server -ldflags="-s -w" ./cmd/nta-server
      
      - name: Download APT dependencies
        run: |
          mkdir -p apt-packages
          cd apt-packages
          
          apt-get download \
            libpcap0.8 \
            libssl3 \
            zlib1g \
            redis-server \
            tcpdump \
            net-tools \
            libhiredis1.1.0 \
            liblua5.4-0 \
            redis-tools || true
          
          apt-cache depends redis-server | grep Depends | awk '{print $2}' | \
            xargs apt-get download 2>/dev/null || true
          
          cd ..
      
      - name: Create offline install script
        run: |
          mkdir -p scripts
          cp scripts/install-offline.sh.template install-offline.sh
          chmod +x install-offline.sh
      
      - name: Prepare release package
        run: |
          mkdir -p nta-release
          
          cp nta-server nta-release/
          cp zeek-6.0.3-ubuntu24.04-x64.tar.gz nta-release/
          cp -r apt-packages nta-release/
          cp -r zeek-scripts nta-release/
          cp -r config nta-release/
          cp install-offline.sh nta-release/
          cp README.md nta-release/
          cp DEPLOYMENT.md nta-release/
          
          tar -czf nta-v4.0-ubuntu24.04-x64.tar.gz nta-release/
      
      - name: Generate checksums
        run: |
          sha256sum nta-v4.0-ubuntu24.04-x64.tar.gz > nta-v4.0-ubuntu24.04-x64.tar.gz.sha256
          
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: nta-ubuntu24.04-x64-release
          path: |
            nta-v4.0-ubuntu24.04-x64.tar.gz
            nta-v4.0-ubuntu24.04-x64.tar.gz.sha256
          retention-days: 30
      
      - name: Display package info
        run: |
          echo "=========================================="
          echo "Package created successfully!"
          echo "=========================================="
          ls -lh nta-v4.0-ubuntu24.04-x64.tar.gz
          echo ""
          echo "SHA256:"
          cat nta-v4.0-ubuntu24.04-x64.tar.gz.sha256
          echo ""
          echo "Contents:"
          tar -tzf nta-v4.0-ubuntu24.04-x64.tar.gz | head -20